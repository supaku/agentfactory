name: Publish to npm and GitHub Packages

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  ci:
    name: CI
    uses: ./.github/workflows/ci.yml

  publish:
    name: Publish to npm and GitHub Packages
    runs-on: ubuntu-latest
    needs: [ci]
    permissions:
      contents: write
      packages: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
          registry-url: https://registry.npmjs.org

      - name: Remove deprecated always-auth from .npmrc
        run: sed -i '/always-auth/d' ~/.npmrc

      - run: pnpm install --frozen-lockfile
      - run: pnpm build

      # Required for npm Trusted Publishers (OIDC)
      - name: Update npm for Trusted Publishers
        run: npm install -g npm@latest

      # Extract version from tag (strip leading 'v')
      - name: Set version from tag
        run: echo "RELEASE_VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_ENV

      # Check if version already exists on npm
      - name: Check if version exists on npm
        id: check
        run: |
          if npm view @supaku/agentfactory@$RELEASE_VERSION version 2>/dev/null; then
            echo "Version $RELEASE_VERSION already exists on npm"
            echo "should_publish=false" >> $GITHUB_OUTPUT
          else
            echo "Version $RELEASE_VERSION does not exist on npm, will publish"
            echo "should_publish=true" >> $GITHUB_OUTPUT
          fi

      # Update all package versions to match the tag
      - name: Set package versions
        if: steps.check.outputs.should_publish == 'true'
        run: |
          for pkg in packages/linear packages/core packages/server packages/cli; do
            cd "$pkg"
            npm version "$RELEASE_VERSION" --no-git-tag-version
            cd "$GITHUB_WORKSPACE"
          done

      # Publish packages in dependency order to npm
      # 1. linear (no internal deps)
      # 2. core (depends on linear)
      # 3. server (depends on core + linear)
      # 4. cli (depends on core + linear)
      - name: Publish @supaku/agentfactory-linear to npm
        if: steps.check.outputs.should_publish == 'true'
        run: pnpm --filter @supaku/agentfactory-linear publish --no-git-checks --provenance --access public

      - name: Publish @supaku/agentfactory to npm
        if: steps.check.outputs.should_publish == 'true'
        run: pnpm --filter @supaku/agentfactory publish --no-git-checks --provenance --access public

      - name: Publish @supaku/agentfactory-server to npm
        if: steps.check.outputs.should_publish == 'true'
        run: pnpm --filter @supaku/agentfactory-server publish --no-git-checks --provenance --access public

      - name: Publish @supaku/agentfactory-cli to npm
        if: steps.check.outputs.should_publish == 'true'
        run: pnpm --filter @supaku/agentfactory-cli publish --no-git-checks --provenance --access public

      # Publish to GitHub Packages
      - name: Setup Node.js for GitHub Packages
        if: steps.check.outputs.should_publish == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://npm.pkg.github.com
          scope: '@supaku'

      - name: Remove deprecated always-auth from .npmrc
        if: steps.check.outputs.should_publish == 'true'
        run: sed -i '/always-auth/d' ~/.npmrc

      - name: Publish @supaku/agentfactory-linear to GitHub Packages
        if: steps.check.outputs.should_publish == 'true'
        run: pnpm --filter @supaku/agentfactory-linear publish --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish @supaku/agentfactory to GitHub Packages
        if: steps.check.outputs.should_publish == 'true'
        run: pnpm --filter @supaku/agentfactory publish --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish @supaku/agentfactory-server to GitHub Packages
        if: steps.check.outputs.should_publish == 'true'
        run: pnpm --filter @supaku/agentfactory-server publish --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish @supaku/agentfactory-cli to GitHub Packages
        if: steps.check.outputs.should_publish == 'true'
        run: pnpm --filter @supaku/agentfactory-cli publish --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Create GitHub Release
      - name: Create GitHub Release
        if: steps.check.outputs.should_publish == 'true'
        run: |
          gh release create "$GITHUB_REF_NAME" \
            --title "$GITHUB_REF_NAME" \
            --generate-notes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
