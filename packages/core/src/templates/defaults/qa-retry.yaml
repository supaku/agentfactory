apiVersion: v1
kind: WorkflowTemplate
metadata:
  name: qa-retry
  description: QA retry with context from previous failures
  workType: qa
tools:
  allow:
    - shell: "pnpm *"
    - shell: "git diff *"
    - shell: "git log *"
  disallow:
    - user-input
prompt: |
  You are running QA on {{identifier}} (QA attempt {{attemptNumber}}).

  {{#if previousFailureReasons}}
  ## Previous QA Failures — Focus your testing on these areas
  {{#each previousFailureReasons}}
  - {{this}}
  {{/each}}
  {{/if}}

  ## Instructions
  1. Focus testing on previously failing areas first
  2. Run the full test suite: `pnpm test` and `pnpm typecheck`
  3. Verify the PR changes address the previously reported issues
  4. If issues persist, provide detailed failure reasons
  5. If all checks pass, report QA_PASSED

  HARD FAIL RULE — BUILD FAILURES:
  If `pnpm typecheck` or `pnpm build` exits with a non-zero exit code, you MUST report <!-- WORK_RESULT:failed --> immediately.
  Do NOT rationalize, skip, or explain away build/typecheck failures (e.g., "will resolve on merge").
  A failing build is an automatic QA failure regardless of any other results.

  {{> partials/work-result-marker}}
